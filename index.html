<!DOCTYPE html>
<html lang="ja">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AS/board</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/indexStyle.css">
</head>
<body>
  
  <!-- 네비게이션 바 /로그인 회원등록 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/index.html">Anime Sanctuary</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto" id="auth-buttons"> <!-- ID 추가 -->
        <li class="nav-item">
          <a class="nav-link" href="./login.html" id="login-button">ログイン</a> <!-- ID 추가 -->
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./register.html" id="register-button">新規登録</a> <!-- ID 추가 -->
        </li>
      </ul>
    </div>
  </nav>

  <!-- 검색 바 추가 및 중앙 고정 -->
  <form class="form-inline" id="search-form">
    <input class="form-control" type="search" placeholder="キーワードやクリエイターで検索" aria-label="Search" id="search-input">
    <button class="btn btn-outline-success" type="submit" id="search-button">検索</button>
  </form>
  <!-- 검색 바 끝 -->

  <!-- 사이드바 -->
  <div class="sidebar">
    <h5>メインリスト</h5>
    <ul class="list-group list-group-flush">
      <li class="list-group-item">アニメ</li>
      <li class="list-group-item">漫画</li>
      <li class="list-group-item">人気作品</li>
      <li class="list-group-item">キャラクター</li>
      <li class="list-group-item">フォーラム</li>
    </ul>
  </div>

  <!-- 메인 콘텐츠 -->
  <div class="main-content">
    <div class="container-fluid">
      <!-- 카드 행을 생성할 위치 -->
      <div id="card-rows"></div>
    </div>
  </div>

  <!-- 외부 JavaScript 파일 로드 -->
  <script src="javascript/mainUI.js"></script>

  <!-- JavaScript 코드 -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      checkLoginStatus(); // 페이지 로드 시 로그인 상태 확인
      initialize(); // 초기화 함수 호출
    });

    // 로그인 상태 확인 및 버튼 변경 함수들
    function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem("isLoggedIn"); // 로그인 상태를 localStorage에서 확인

      if (isLoggedIn === "true") {
        showLogoutButton();
      } else {
        showLoginAndRegisterButtons();
      }
    }

    function showLogoutButton() {
      const authButtons = document.getElementById("auth-buttons");
      authButtons.innerHTML = `
        <li class="nav-item">
          <a class="nav-link" href="#" id="logout-button" onclick="logout()">ログアウト</a>
        </li>
      `;
    }

    function showLoginAndRegisterButtons() {
      const authButtons = document.getElementById("auth-buttons");
      authButtons.innerHTML = `
        <li class="nav-item">
          <a class="nav-link" href="./login.html" id="login-button">ログイン</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="./register.html" id="register-button">新規登録</a>
        </li>
      `;
    }

    function login() {
      // 로그인 성공 후 실행할 로직
      localStorage.setItem("isLoggedIn", "true");
      alert("로그인에 성공했습니다.");
      checkLoginStatus(); // 로그인 상태 확인 및 버튼 업데이트
    }

    function logout() {
      // 로그아웃 시 실행할 로직 예시
      localStorage.removeItem("isLoggedIn");
      checkLoginStatus();
    }

    // 서버에서 게시물 데이터를 가져오는 함수
    async function fetchPosts() {
      try {
        const response = await fetch("http://localhost:9000/api/notes"); // ★ 모든 게시물을 가져오는 엔드포인트
        if (!response.ok) {
          throw new Error("Failed to fetch posts");
        }
        posts = await response.json(); 
        displayPosts(); // ★ 서버로부터 데이터를 가져온 후, 게시물들을 화면에 표시합니다.
      } catch (error) {
        console.error("Error fetching posts:", error);
      }
    }

    // 게시물 데이터를 카드로 표시하는 함수
    function displayPosts() {
      const cardRows = [];

      for (let i = 0; i < categoryNames.length; i++) {
        const cards = [];
        for (let j = 0; j < 5; j++) {
          const index = (currentIndexes[i] + j) % posts.length;
          const post = posts[index];
          cards.push(
            createCard(
              images[index % images.length],
              post.title || "Default Title",
              post.contents || "Default Content",
              `Author ${index + 1}`,
              `Date ${index + 1}`,
              post.id // ★ 각 카드에 해당 게시물의 ID를 포함합니다.
            )
          );
        }
        cardRows.push(createCardRow(i, cards, categoryNames[i]));
      }

      document.getElementById("card-rows").innerHTML = cardRows.join("");

      for (let i = 0; i < categoryNames.length; i++) {
        const container = document.querySelector(`#wrapper-${i} .card-container`);
        const cards = container.querySelectorAll(".card");
        if (cards[2]) {
          cards[2].style.transform = "scale(1.1)";
        }
      }
    }

    // 카드 요소를 생성하는 함수
    function createCard(image, title, description, author, date, id) {
      return `
        <div class="card shadow" style="position: relative;" onclick="redirectToPost('${id}')"> <!-- ★ 클릭 시 ID를 포함하여 이동 -->
          <img src="${image}" class="card-img-top">
          <div class="card-body">
            <span class="badge rounded-pill bg-primary">News</span>
            <h4 class="mt-2">${title}</h4>
            <p class="card-text">${description}</p>
            <div class="card-meta">
              <p class="card-author"><strong>Author:</strong> ${author}</p>
            </div>
          </div>
          <div class="icon-container">
            <button class="icon-button heart" onclick="toggleIcon(event, this)">
              <img src="icon/heart-fill.svg">
            </button>
            <span class="like-count">235</span>
            <button class="icon-button bookmark" onclick="toggleIcon(event, this)">
              <img src="/icon/bookmark-plus-fill.svg">
            </button>
          </div>
        </div>
      `;
    }

    // 게시물 클릭 시 이동하는 함수
    function redirectToPost(id) {
      console.log("Navigating to post with ID:", id); // ★ ID가 제대로 전달되는지 확인
      window.location.href = `post.html?id=${id}`; // ★ 게시물의 ID를 URL에 포함하여 상세 페이지로 이동합니다.
    }

    function initialize() {
      fetchPosts(); // ★ 초기화 시 서버로부터 게시물 데이터를 가져옵니다.
    }
  </script>
</body>
</html>
